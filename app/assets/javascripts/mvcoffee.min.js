// Generated by CoffeeScript 1.8.0
/*

MVCoffee

Copyright 2014, Kirk Bowers
MIT License

Version 1.0.0
 */(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}},n=[].slice,r=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};typeof exports!="undefined"&&exports!==null?e=exports:(this.MVCoffee||(this.MVCoffee={}),e=this.MVCoffee),Array.isArray||(Array.isArray=function(e){return Object.prototype.toString.call(e)==="[object Array]"}),this.link_to=function(e,t,n){var r;return n==null&&(n={}),r='<a href="'+t+'"',n.id!=null&&(r+=' id="'+n.id+'"'),n["class"]!=null&&(r+=' class="'+n["class"]+'"'),n.method!=null&&(r+=' rel="nofollow" data-method="'+n.method+'"'),r+=">"+e+"</a>",r},e.Pluralizer=function(){function e(){}return e.irregulars={man:"men",woman:"women",child:"children",person:"people",mouse:"mice",goose:"geese",datum:"data",alumnus:"alumni",cactus:"cacti",hippopotamus:"hippopotami"},e.addIrregulars=function(e){var t,n,r;r=[];for(n in e)t=e[n],r.push(this.irregulars[n]=t);return r},e.addIrregular=e.addIrregulars,e.pluralize=function(e){var t,n,r,i,s,o,u;return u=e.split("_"),t=u.length-1,i=u[t],o=this.irregulars[i],o?(u[t]=o,u.join("_")):(s=i.length,n=i[s-1],r=i.slice(s-2,+(s-1)+1||9e9),n==="s"||n==="z"?i+="es":r==="ch"||r==="sh"?i+="es":n==="y"?i=i.substring(0,s-1)+"ies":i+="s",u[t]=i,u.join("_"))},e}(),e.Runtime=function(){function r(){this.processServerData=t(this.processServerData,this),this.getErrors=t(this.getErrors,this),this.getSession=t(this.getSession,this),this.setSession=t(this.setSession,this),this.getFlash=t(this.getFlash,this),this.setFlash=t(this.setFlash,this),this.controllers={},this.modelStore=new e.ModelStore,this.active=[],this._flash={},this._oldFlash={},this.session={},this.dataId="mvcoffee_json",this.onfocusId=null}return r.prototype.register_controllers=function(e){var t,n,r;r=[];for(n in e)t=e[n],r.push(this._addController(new t(n,this),n));return r},r.prototype._addController=function(e,t){return t!=null?this.controllers[t]=e:this.controllers[e.selector]=e},r.prototype.register_models=function(e){return this.modelStore.register_models(e)},r.prototype.broadcast=function(){var e,t,r,i,s,o,u,a,f,l;s=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],Array.isArray(s)||(s=[s]),f=this.active,l=[];for(u=0,a=f.length;u<a;u++)t=f[u],o=!1,r=0,l.push(function(){var n;n=[];while(!o&&r<s.length)i=s[r],i&&t[i]!=null&&typeof t[i]=="function"&&(o=!0,t[i].apply(t,e)),n.push(r++);return n}());return l},r.prototype.setFlash=function(e){var t,n,r;r=[];for(t in e)n=e[t],r.push(this._flash[t]=n);return r},r.prototype.getFlash=function(e){var t;return(t=this._flash[e])!=null?t:this._oldFlash[e]},r.prototype.setSession=function(e){var t,n,r;r=[];for(t in e)n=e[t],r.push(this.session[t]=n);return r},r.prototype.getSession=function(e){return this.session[e]},r.prototype.getErrors=function(){return this.errors},r.prototype.processServerData=function(e,t){var n,r,i,s;t==null&&(t="");if(e){console.log("Got data from server: "+JSON.stringify(e)),this.modelStore.load(e),e.flash!=null&&this.setFlash(e.flash);if(e.session!=null){s=e.session;for(r in s)i=s[r],this.session[r]=i}return this.errors=e.errors,e.redirect!=null?Turbolinks.visit(e.redirect):this.errors?(t?n=[""+t+"_errors","errors"]:n="errors",end,this.broadcast(n,this.errors)):this.broadcast([t,"render"])}},r.prototype.go=function(){var e,t,n,r,i,s;this._oldFlash=this._flash,this._flash={},n=$("#"+this.dataId).html(),i=null,n&&(i=$.parseJSON(n)),this.processServerData(i),r=[],s=this.controllers;for(t in s)e=s[t],jQuery("#"+t).length>0&&r.push(e);return this.active.length&&(this.broadcast("stop"),window.onbeforeunload=null,window.onfocus=null,window.onblur=null,this.onfocusId&&clearInterval(this.onfocusId),this.onfocusId=null),r.length?(this.active=r,this.broadcast("start"),window.onfocus=function(e){return function(){return e._startSafariKludge(),console.log("onfocus detected, resuming"),e.broadcast("resume")}}(this),window.onblur=function(e){return function(){return e._stopSafariKludge(),console.log("onblur detected, pausing"),e.broadcast("pause")}}(this),this._startSafariKludge()):this.active=[]},r.prototype._startSafariKludge=function(){return this._stopSafariKludge(),this.lastFired=(new Date).getTime(),console.log("safari kludge setting last fired to "+this.lastFired),this.onfocusId=setInterval(function(e){return function(){var t;return t=(new Date).getTime(),t-e.lastFired>2e3&&(console.log("safari onfocus kludge fired, now = "+t+", last = "+e.lastFired),e.broadcast("pause"),e.broadcast("resume")),e.lastFired=t}}(this),500)},r.prototype._stopSafariKludge=function(){return this.onfocusId!=null&&clearInterval(this.onfocusId),this.onfocusId=null},r.prototype.run=function(){var e;return e=this,$(function(){return e.go()}),$(document).on("pagebeforeshow",function(){return e.go()})},r}(),e.Controller=function(){function e(e,n){this.id=e,this.runtime=n,this.errors=t(this.errors,this),this.selector="#"+e,this.timerId=null,this.isActive=!1,this.processServerData=this.runtime.processServerData,this.getFlash=this.runtime.getFlash,this.setFlash=this.runtime.setFlash,this.getSession=this.runtime.getSession,this.setSession=this.runtime.setSession,this.getErrors=this.runtime.getErrors,this.timerCount=0}return e.prototype.start=function(){var e;this.isActive=!0,e=jQuery("meta[name='csrf-token']");if(e!=null?e.length:void 0)this.authenticity_token=e.attr("content");this.onStart(),this.render();if(this.refresh!=null)return this.startTimer()},e.prototype.resume=function(){this.onResume(),console.log("resume called on controller "+this.toString()),console.log("isActive = "+this.isActive);if(this.refresh!=null&&!this.isActive)return this.isActive=!0,this.refresh(),this.startTimer()},e.prototype.pause=function(){this.onPause(),console.log("pause called on controller "+this.toString());if(this.refresh!=null)return this.isActive=!1,this.stopTimer()},e.prototype.stop=function(){this.isActive=!1,this.onStop();if(this.refresh!=null)return this.stopTimer()},e.prototype.turbolinkForms=function(e){var t,n;e==null&&(e={});if(typeof Turbolinks!="undefined"&&Turbolinks!==null)return n=this,e.scope!=null?t=jQuery(e.scope):t=jQuery("body"),t.find("form").each(function(t){return function(t,r){var i,s;return console.log("turbolinking "+r.id),e[r.id]!=null?(s=e[r.id],$(r).submit(function(){var e,t,i,o;return t=!0,o=s.model,o!=null&&(o.populate(),i=""+r.id+"_errors",n[i]!=null?n[i](o.errors):console.log("!!! method "+i+" not implemented !!!"),t=o.isValid()),e=s.confirm,t&&e!=null&&(e instanceof Function?t=e():t=window.confirm(e)),t&&n.turbolinksSubmit(r),!1})):(i=$(r),r.method==="get"||r.method==="GET"?$(r).submit(function(){return Turbolinks.visit(r.action),!1}):$(r).submit(function(){return n.turbolinksSubmit(r),!1}))}}(this)),console.log("Looking for post links"),t.find("a[data-method='post']").each(function(e){return function(t,n){return console.log("Found a post link! url="+n.href),console.log("element.id = "+n.id),n.id?console.log("Passes existence test"):console.log("Fails existence test"),jQuery(n).click(function(){var t,r;return r=!0,t=jQuery(n).data("confirm"),t!=null&&(r=window.confirm(t)),r&&jQuery.ajax({url:n.href,type:"POST",success:function(t){return e.runtime.processServerData(t,n.id)},dataType:"json"}),!1})}}(this)),t.find("a[data-method='delete']").each(function(e){return function(t,n){return console.log("Found a delete link! url="+n.href),jQuery(n).click(function(){var t,r;return r=!0,t=jQuery(n).data("confirm"),t!=null&&(r=window.confirm(t)),r&&jQuery.ajax({url:n.href,type:"DELETE",success:function(t){return e.runtime.processServerData(t,n.id)},dataType:"json"}),!1})}}(this))},e.prototype.get=function(e,t){return t==null&&(t="render"),$.get(e,this.runtime.session,function(e){return function(n){return e.runtime.processServerData(n,t)}}(this),"json")},e.prototype.post=function(e,t,n){return t==null&&(t={}),n==null&&(n="render"),$.extend(t,{authenticity_token:this.authenticity_token},this.session),$.post(e,t,function(e){return function(t){return e.runtime.processServerData(t,n)}}(this),"json")},e.prototype.turbolinksSubmit=function(e){var t;return t=e,e instanceof jQuery&&(t=e.get(0)),console.log("Submiting "+t.id+" over turbolinks"),jQuery.post(t.action,$(t).serialize(),function(e){return function(n){return e.processServerData(n,t.id)}}(this),"json"),!1},e.prototype.refreshInterval=6e4,e.prototype.refresh=null,e.prototype.onStart=function(){},e.prototype.onPause=function(){},e.prototype.onResume=function(){},e.prototype.onStop=function(){},e.prototype.render=function(){},e.prototype.errors=function(e){return console.log("!!!!! The errors method was called on controller "+this.toString()+" but not implemented!!!!!")},e.prototype.toString=function(){return this.id},e.prototype.startTimer=function(){var e;this.timerId!=null&&this.stopTimer();if(this.refreshInterval!=null&&this.refreshInterval>0)return e=this,this.timerCount+=1,console.log("Starting timer with count of "+this.timerCount),this.timerId=setInterval(function(){return console.log("Firing timer with count of "+e.timerCount),e.refresh.call(e)},this.refreshInterval),console.log("Started timerId "+this.timerId)},e.prototype.stopTimer=function(){return console.log("Stopping timer"),this.timerId!=null&&(console.log("clearing the interval with timerId "+this.timerId),clearInterval(this.timerId)),this.timerId=null},e}(),e.ModelStore=function(){function t(e){e==null&&(e={}),this.modelDefs={},this.store={},this.register_models(e)}return t.prototype.MIN_DATA_FORMAT_VERSION="1.0.0",t.prototype.register_models=function(e){var t,n,r;e==null&&(e={}),r=[];for(n in e)t=e[n],r.push(this._addModel(n,t));return r},t.prototype._addModel=function(t,n){var r,i;return this.modelDefs[t]=n,(r=n.prototype).modelName||(r.modelName=t),(i=n.prototype).modelNamePlural||(i.modelNamePlural=e.Pluralizer.pluralize(t)),n.prototype.modelStore=this,this.store[t]={}},t.prototype.knowsAbout=function(e){return this.store[e]!=null},t.prototype.load_model_data=function(e,t){var n,r,i,s,o;if(Array.isArray(t)){o=[];for(i=0,s=t.length;i<s;i++)r=t[i],n=new this.modelDefs[e](r),o.push(this.store[e][n.id]=n);return o}return n=new this.modelDefs[e](t),this.store[e][n.id]=n},t.prototype.load=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;if(e.mvcoffee_version==null||e.mvcoffee_version<this.MIN_DATA_FORMAT_VERSION)throw"MVCoffee.DataStore requires minimum data format "+this.MIN_DATA_FORMAT_VERSION;c=e.models,p=[];for(i in c){t=c[i];if(this.modelDefs[i]!=null){if(t.replace_on!=null){if(Array.isArray(t.replace_on)){o=[],h=t.replace_on;for(u=0,f=h.length;u<f;u++)n=h[u],o=o.concat(this.where(i,n))}else o=this.where(i,t.replace_on);for(a=0,l=o.length;a<l;a++)s=o[a],this._delete_with_cascade(i,s.id)}t.data!=null&&this.load_model_data(i,t.data),t["delete"]!=null?Array.isArray(t["delete"])?p.push(function(){var e,n,s,o;s=t["delete"],o=[];for(e=0,n=s.length;e<n;e++)r=s[e],o.push(this._delete_with_cascade(i,r));return o}.call(this)):p.push(this._delete_with_cascade(i,t["delete"])):p.push(void 0)}else p.push(void 0)}return p},t.prototype.find=function(e,t){var n;return(n=this.store[e])!=null?n[t]:void 0},t.prototype.findBy=function(e,t){var n,r,i,s,o,u,a,f;o=(f=this.store[e])!=null?f:{},u=null;for(n in o){s=o[n],r=!0;for(i in t)a=t[i],s[i]!==a&&(r=!1);r&&(u||(u=s))}return u},t.prototype.where=function(e,t){var n,r,i,s,o,u,a;o=this.store[e],u=[];for(n in o){s=o[n],r=!0;for(i in t)a=t[i],s[i]!==a&&(r=!1);r&&u.push(s)}return u},t.prototype.all=function(e){var t,n,r,i;r=this.store[e],i=[];for(t in r)n=r[t],i.push(n);return i},t.prototype["delete"]=function(e,t){return delete this.store[e][t]},t.prototype._delete_with_cascade=function(e,t){var n;return n=this.store[e][t],n["delete"]!=null&&n["delete"]instanceof Function?n["delete"]():delete this.store[e][t]},t}(),e.Model=function(){function n(e){this.addError=t(this.addError,this),e!=null&&this.populate(e)}return n.prototype.modelName=null,n.prototype.fields=[],n.prototype._associations_has_many=[],n.prototype.errors=[],n.prototype.valid=!0,n.order=function(e,t,n){var r,i,s,o,u,a;return n==null&&(n={}),o=e,a=t.split(/\s+/),s=a[0],r=a[1],u=1,r!=null&&r==="desc"&&(u=-1),i=!1,n.ignoreCase&&(i=!0),o.sort(function(e,t){return e=e[s],t=t[s],i&&(e.toLowerCase&&(e=e.toLowerCase()),t.toLowerCase&&(t=t.toLowerCase())),e>t?u:e<t?-u:0}),o},n.all=function(e){var t;return e==null&&(e={}),t=this.prototype.modelStore.all(this.prototype.modelName),e.order&&(t=this.sort(t,e.order)),t},n.find=function(e){return this.prototype.modelStore.find(this.prototype.modelName,e)},n.prototype["delete"]=function(){var e,t,n,r,i,s,o,u;u=this._associations_has_many;for(r=0,s=u.length;r<s;r++){e=u[r],n=this[e]();for(i=0,o=n.length;i<o;i++)t=n[i],t["delete"]()}return this.modelStore["delete"](this.modelName,this.id)},n.prototype.destroy=function(){return this["delete"]()},n.findFieldIndex=function(e){var t,n,r,i,s;t=this.prototype.fields,r=-1;for(n=i=0,s=t.length;0<=s?i<s:i>s;n=0<=s?++i:--i)t[n].name===e&&(r=n);return r},n.validates=function(e,t){var n,r;return this.prototype.hasOwnProperty("fields")||(this.prototype.fields=[]),n=this.prototype.fields,r=this.findFieldIndex(e),r<0?n.push({name:e,validates:[t]}):(e=n[r],e.validates!=null?Array.isArray(e.validates)?e.validates.push(t):e.validates=[e.validates,t]:e.validates=[t])},n.types=function(e,t){var n,r;return this.prototype.hasOwnProperty("fields")||(this.prototype.fields=[]),n=this.prototype.fields,r=this.findFieldIndex(e),r<0?n.push({name:e,type:t}):n[r].type=t},n.displays=function(e,t){var n,r;return this.prototype.hasOwnProperty("fields")||(this.prototype.fields=[]),n=this.prototype.fields,r=this.findFieldIndex(e),r<0?n.push({name:e,display:t}):n[r].display=t},n.hasMany=function(t,n){var r,i;return n==null&&(n={}),r=n.as||e.Pluralizer.pluralize(t),this.prototype.hasOwnProperty("_associations_has_many")||(this.prototype._associations_has_many=[]),this.prototype._associations_has_many.push(r),i=this,this.prototype[r]=function(){var e,r,s,o;return s=i.prototype.modelStore,r=n.foreignKey||n.foreign_key||""+i.prototype.modelName+"_id",o=[],s!=null&&(e={},e[r]=this.id,o=s.where(t,e)),n.order&&(o=i.order(o,n.order)),o}},n.has_many=n.hasMany,n.belongsTo=function(e,t){var n,r,i;return t==null&&(t={}),r=t.as||e,n=t.foreignKey||t.foreign_key||""+e+"_id",i=this,this.prototype[r]=function(){var t,r;return t=i.prototype.modelStore,r=null,t!=null&&(r=t.find(e,this[n])),r}},n.belongs_to=n.belongsTo,n.prototype.isValid=function(){return this.valid},n.prototype.populate=function(e){var t,n,r,i,s,o;if(e!=null)for(t in e)r=e[t],e.hasOwnProperty(t)&&((r instanceof Object||r instanceof Array)&&this.modelStore.knowsAbout(t)?this.modelStore.load_model_data(t,r):this[t]=r);else{o=this.fields;for(i=0,s=o.length;i<s;i++)t=o[i],this.modelName!=null?n="#"+this.modelName+"_"+t.name:n="#"+t.name,t.type!=null&&t.type==="boolean"?this[t.name]=jQuery(n).is(":checked"):this[t.name]=jQuery(n).val()}return this.validate()},n.prototype.validate=function(){var e,t,n,i,s,o,u,a,f,l,c,h,p,d;this.valid=!0,this.errors=[],d=this.fields;for(l=0,h=d.length;l<h;l++){t=d[l];if(t.validates!=null){a=t.validates,Array.isArray(a)||(a=[a]);for(c=0,p=a.length;c<p;c++){u=a[c];if(u.test==="acceptance")f=u.accept,f==null&&(f="1"),this.__performValidation(t,u,null,"must be accepted",function(e){return e===f});else if(u.test==="confirmation")e=this[""+t.name+"_confirmation"],this.__performValidation(t,u,null,"doesn't match confirmation",function(t){return t!=null&&t!==""&&e!=null&&t===e});else if(u.test==="email")this.__performValidation(t,u,null,"must be a valid email address",function(e){return e!=null&&e.match(/^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/)});else if(u.test==="exclusion")i=u["in"]||[],this.__performValidation(t,u,null,"is reserved",function(e){return e!=null&&!(r.call(i,e)>=0)});else if(u.test==="format")i=u["with"]||/.*/,this.__performValidation(t,u,null,"is invalid",function(e){return e!=null&&i.test(e)});else if(u.test==="inclusion")i=u["in"]||[],this.__performValidation(t,u,null,"is not included in the list",function(e){return e!=null&&r.call(i,e)>=0});else if(u.test==="length")o=function(e){return e.split("")},u.tokenizer!=null&&(o=u.tokenizer),u.minimum!=null&&(typeof u.minimum=="number"?(s=null,f=u.minimum):(s=u.minimum,f=s.value),this.__performValidation(t,u,s,"is too short (minimum is "+f+" characters)",function(e){return e!=null&&o(e).length>=f})),u.maximum!=null&&(typeof u.maximum=="number"?(s=null,f=u.maximum):(s=u.maximum,f=s.value),this.__performValidation(t,u,s,"is too long (maximum is "+f+" characters)",function(e){return e==null||o(e).length<=f})),u["is"]!=null&&(typeof u["is"]=="number"?(s=null,f=u.is):(s=u.is,f=s.value),this.__performValidation(t,u,s,"is the wrong length (must be "+f+" characters)",function(e){return e!=null&&o(e).length===f}));else if(u.test==="numericality")u.only_integer!=null&&u.only_integer?n=this.__performValidation(t,u,null,"must be an integer",function(e){return/^[-+]?\d+$/.test(e)}):n=this.__performValidation(t,u,null,"must be a number",function(e){var t;return t=parseFloat(e),/^[-+]?\d*\.?\d*(e\d+)?$/.test(e)&&t===t}),n&&(u.greater_than!=null&&(typeof u.greater_than=="number"?(f=u.greater_than,s=null):(s=u.greater_than,f=s.value),this.__performValidation(t,u,s,"must be greater than "+f,function(e){return parseFloat(e)>f})),u.greater_than_or_equal_to!=null&&(typeof u.greater_than_or_equal_to=="number"?(s=null,f=u.greater_than_or_equal_to):(s=u.greater_than_or_equal_to,f=s.value),this.__performValidation(t,u,s,"must be greater than or equal to "+f,function(e){return parseFloat(e)>=f})),u.equal_to!=null&&(typeof u.equal_to=="number"?(s=null,f=u.equal_to):(s=u.equal_to,f=s.value),this.__performValidation(t,u,s,"must be equal to "+f,function(e){return parseFloat(e)===f})),u.less_than!=null&&(typeof u.less_than=="number"?(f=u.less_than,s=null):(s=u.less_than,f=s.value),this.__performValidation(t,u,s,"must be less than "+f,function(e){return parseFloat(e)<f})),u.less_than_or_equal_to!=null&&(typeof u.less_than_or_equal_to=="number"?(s=null,f=u.less_than_or_equal_to):(s=u.less_than_or_equal_to,f=s.value),this.__performValidation(t,u,s,"must be less than or equal to "+f,function(e){return parseFloat(e)<=f})),u.odd!=null&&(typeof u.odd=="boolean"?(s=null,f=u.odd):(s=u.odd,f=!0),f&&this.__performValidation(t,u,s,"must be odd",function(e){return Math.abs(parseFloat(e))%2===1})),u.even!=null&&(typeof u.even=="boolean"?(s=null,f=u.even):(s=u.even,f=!0),f&&this.__performValidation(t,u,s,"must be even",function(e){return parseFloat(e)%2===0})));else if(u.test==="presence")this.__performValidation(t,u,null,"can't be empty",function(e){return e!=null&&/\S+/.test(e)});else if(u.test==="absence")this.__performValidation(t,u,null,"must be blank",function(e){return e==null||!/\S+/.test(e)});else{if(typeof this[u.test]!="function")throw"custom validation is not a function";this.__performValidation(t,u,null,"is invalid",this[u.test])}}}}return this.valid},n.prototype.__performValidation=function(e,t,n,r,i){var s;if(t.only_if!=null&&!this[t.only_if]())return!0;if(t.unless!=null&&this[t.unless]())return!0;if(n!=null){if(n.only_if!=null&&!this[n.only_if]())return!0;if(n.unless!=null&&this[n.unless]())return!0}return s=this[e.name],t.allow_null!=null&&t.allow_null&&s==null?!0:t.allow_blank!=null&&t.allow_blank&&(s==null||!/\S+/.test(s))?!0:i(s)?!0:(this.addError(e,t,n,r),!1)},n.prototype.addError=function(e,t,n,r){var i;return this.valid=!1,i=e.display,i==null&&(i=e.name,i.length>0&&(i=i[0].toUpperCase()+i.slice(1),i=i.split("_").join(" "))),(n!=null?n.message:void 0)!=null?this.errors.push(""+i+" "+n.message):(t!=null?t.message:void 0)!=null?this.errors.push(""+i+" "+t.message):this.errors.push(""+i+" "+r)},n}()}).call(this);